#!/bin/bash
#! shellcheck disable=SC2154
source entities || exit 2
	version.set '0.1'
	trap.set on
	strict.set off
	msg.verbose.set on
	msg.prefix.set "$PRG"
	
main() {
	local -a args=()
	while (( $# )); do
		case "$1" in
			-V|--version)		echo "$_ent_VERSION"; return 0;;
			-h|--help)			usage; return 0;;
			-?|--*)					msg.err "Invalid option [$1]"; return 22;;
			*)							args+=( "$1" );;
		esac
		shift
	done
	(( ${#args[@]} != 2 )) && { usage; return 22; }
	OLDPREFIX=${args[0]}
	NEWPREFIX=${args[1]}
	
	msg.warn "Changing entities.bash global variable prefix"
	msg.warn "in *all* files in directory $ENTITIES"
	msg.warn "from [$OLDPREFIX] to [$NEWPREFIX]"
	msg.yn   "Do you wish to proceed?" || { echo; exit; }
	msg.info "Changing variable prefix [$OLDPREFIX] to [$NEWPREFIX] in [$ENTITIES]"

	cd "$ENTITIES" || exit
	shopt -s globstar
	for file in **; do 
		if grep -rs -m1 "$OLDPREFIX" "$file"; then
			msg.info "Changing [$file]"
			sed -i "s/$OLDPREFIX/$NEWPREFIX/" "$file"
		fi
	done

	msg.info 'Done.'
}

cleanup() {
	local -i err=$?
	[[ -z ${1:-} ]] && err="$1"
	exit "$err"
}

usage() {
	cat <<-usage
	Script  : $PRG
	Desc    : Change entities.bash global variable prefix
	        : in *all* files in directory $ENTITIES
	        : from [oldprefix] to [newprefix].
	        : Default entities.bash prefix is '_ent_'
	        : You will be asked before proceeding.
	        :
	Synopsis: $PRG oldprefix newprefix [-V] [-h]
	        : Note: Make sure both oldprefix and newprefix are sufficiently
	        : unique, in case you wish to change it again.
	        : Use with caution; make backups (see [archivedir]).
	Example : $PRG "_ent_" "_e_"
	usage
	return 0
}

main "$@"
#fin
